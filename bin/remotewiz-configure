#!/usr/bin/env bash
set -euo pipefail

REMOTEWIZ_HOME="${REMOTEWIZ_HOME:-$HOME/.remote-wiz}"
ENV_FILE="$REMOTEWIZ_HOME/.env"
CONFIG_FILE="$REMOTEWIZ_HOME/config.json"

# ── Colors ──────────────────────────────────────────────────────────────────

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

ok()   { printf "  ${GREEN}✓${NC} %s\n" "$*"; }
warn() { printf "  ${YELLOW}!${NC} %s\n" "$*"; }
info() { printf "  ${BOLD}%s${NC}\n" "$*"; }

# ── Helpers ─────────────────────────────────────────────────────────────────

env_get() {
  local key="$1"
  if [ -f "$ENV_FILE" ]; then
    grep -E "^${key}=" "$ENV_FILE" 2>/dev/null | head -1 | sed "s/^${key}=//"
  fi
}

env_set() {
  local key="$1" value="$2"
  if [ ! -f "$ENV_FILE" ]; then
    echo "${key}=${value}" > "$ENV_FILE"
    return
  fi
  if grep -qE "^${key}=" "$ENV_FILE" 2>/dev/null; then
    # Replace existing line — handle both macOS and Linux sed
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "s|^${key}=.*|${key}=${value}|" "$ENV_FILE"
    else
      sed -i "s|^${key}=.*|${key}=${value}|" "$ENV_FILE"
    fi
  else
    echo "${key}=${value}" >> "$ENV_FILE"
  fi
}

prompt_with_default() {
  local label="$1" default="${2:-}"
  if [ -n "$default" ]; then
    printf "  ${label} ${DIM}[${default}]${NC}: " >&2
  else
    printf "  ${label}: " >&2
  fi
  read -r input
  echo "${input:-$default}"
}

prompt_secret() {
  local label="$1" default="${2:-}"
  local masked=""
  if [ -n "$default" ]; then
    masked="${default:0:4}...${default: -4}"
    printf "  ${label} ${DIM}[${masked}]${NC}: " >&2
  else
    printf "  ${label}: " >&2
  fi
  read -rs input
  echo "" >&2  # newline after hidden input
  echo "${input:-$default}"
}

mask_value() {
  local val="$1"
  if [ ${#val} -le 8 ]; then
    echo "****"
  else
    echo "${val:0:4}...${val: -4}"
  fi
}

detect_anthropic_key() {
  # 1. Check current env var
  if [ -n "${ANTHROPIC_API_KEY:-}" ]; then
    echo "env:$ANTHROPIC_API_KEY"
    return 0
  fi

  # 2. Check macOS keychain for Claude CLI OAuth token
  if [[ "$OSTYPE" == "darwin"* ]]; then
    local keychain_data
    keychain_data=$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null || true)
    if [ -n "$keychain_data" ]; then
      local oauth_token
      oauth_token=$(node -e "
        try {
          const d = JSON.parse(process.argv[1]);
          const t = d.claudeAiOauth && d.claudeAiOauth.accessToken;
          if (t) console.log(t);
        } catch {}
      " "$keychain_data" 2>/dev/null || true)
      if [ -n "$oauth_token" ]; then
        echo "claude-cli:$oauth_token"
        return 0
      fi
    fi
  fi

  # 3. Scan shell rc files
  local rc_files=("$HOME/.zshrc" "$HOME/.bashrc" "$HOME/.bash_profile" "$HOME/.zprofile" "$HOME/.profile")
  for rc in "${rc_files[@]}"; do
    if [ -f "$rc" ]; then
      local found
      found=$(grep -E "^export ANTHROPIC_API_KEY=" "$rc" 2>/dev/null | head -1 | sed "s/^export ANTHROPIC_API_KEY=[\"']*//" | sed "s/[\"']*$//")
      if [ -n "$found" ]; then
        echo "$(basename "$rc"):$found"
        return 0
      fi
    fi
  done

  return 1
}

expand_path() {
  local p="$1"
  # Expand ~ to $HOME
  p="${p/#\~/$HOME}"
  echo "$p"
}

# ── Prerequisite Check ──────────────────────────────────────────────────────

if [ ! -f "$ENV_FILE" ]; then
  printf "  ${RED}✗${NC} .env not found at ${ENV_FILE}\n"
  echo "  Run the installer first: curl -fsSL https://raw.githubusercontent.com/raiansar/remotewiz/main/install.sh | bash"
  exit 1
fi

if [ ! -f "$CONFIG_FILE" ]; then
  echo '{ "projects": {} }' > "$CONFIG_FILE"
fi

# ── Banner ──────────────────────────────────────────────────────────────────

echo ""
printf "  ${BOLD}RemoteWiz Configuration Wizard${NC}\n"
echo "  ==============================="
echo ""

# ═════════════════════════════════════════════════════════════════════════════
# Section 1/3: Anthropic API Key
# ═════════════════════════════════════════════════════════════════════════════

printf "  ${CYAN}[1/3]${NC} ${BOLD}Anthropic / Claude API Key${NC}\n"
printf "  ${DIM}Used for the Haiku summarizer. Claude Code tasks use the CLI's own auth.${NC}\n"
echo ""

current_key=$(env_get "ANTHROPIC_API_KEY")

if [ -n "$current_key" ]; then
  local_masked=$(mask_value "$current_key")
  ok "Already set: ${local_masked}"
  echo ""
  change=$(prompt_with_default "Change it? (y/n)" "n")
  if [[ "$change" =~ ^[Yy] ]]; then
    new_key=$(prompt_secret "New API key")
    if [ -n "$new_key" ]; then
      env_set "ANTHROPIC_API_KEY" "$new_key"
      ok "Updated ANTHROPIC_API_KEY"
    fi
  fi
else
  # Try auto-detection
  detected=""
  detected_source=""
  if detected_result=$(detect_anthropic_key); then
    detected_source="${detected_result%%:*}"
    detected="${detected_result#*:}"

    case "$detected_source" in
      claude-cli)
        ok "Found Claude CLI token from macOS keychain"
        ;;
      env)
        ok "Found in \$ANTHROPIC_API_KEY environment variable"
        ;;
      *)
        ok "Found in ~/${detected_source}"
        ;;
    esac

    printf "  Key: ${DIM}$(mask_value "$detected")${NC}\n"
    use_it=$(prompt_with_default "Use this key? (y/n)" "y")
    if [[ "$use_it" =~ ^[Yy] ]]; then
      env_set "ANTHROPIC_API_KEY" "$detected"
      ok "Saved to .env"
    else
      new_key=$(prompt_secret "Enter a different key (or Enter to skip)")
      if [ -n "$new_key" ]; then
        env_set "ANTHROPIC_API_KEY" "$new_key"
        ok "Saved to .env"
      else
        warn "Skipped — set ANTHROPIC_API_KEY in .env later"
      fi
    fi
  else
    warn "No key detected"
    echo ""
    if command -v claude >/dev/null 2>&1; then
      info "Tip: Run 'claude setup-token' to authenticate Claude CLI,"
      info "     then re-run 'remotewiz configure' to pick it up."
    else
      info "Get an API key from https://console.anthropic.com/settings/keys"
    fi
    echo ""
    new_key=$(prompt_secret "Paste API key (or Enter to skip)")
    if [ -n "$new_key" ]; then
      env_set "ANTHROPIC_API_KEY" "$new_key"
      ok "Saved to .env"
    else
      warn "Skipped — set ANTHROPIC_API_KEY in .env later"
    fi
  fi
fi

echo ""

# ═════════════════════════════════════════════════════════════════════════════
# Section 2/3: Discord Configuration
# ═════════════════════════════════════════════════════════════════════════════

printf "  ${CYAN}[2/3]${NC} ${BOLD}Discord Bot${NC}\n"
printf "  ${DIM}Optional — skip if you only use the web UI.${NC}\n"
echo ""

setup_discord=$(prompt_with_default "Set up Discord bot? (y/n)" "n")

if [[ "$setup_discord" =~ ^[Yy] ]]; then
  echo ""
  info "You can find these in the Discord Developer Portal."
  echo ""

  # Bot Token
  current_token=$(env_get "DISCORD_TOKEN")
  new_token=$(prompt_with_default "Bot token" "$current_token")
  if [ -n "$new_token" ]; then
    env_set "DISCORD_TOKEN" "$new_token"
    ok "Bot token saved"
  fi

  # Guild ID
  current_guild=$(env_get "DISCORD_GUILD_ID")
  new_guild=$(prompt_with_default "Server (guild) ID" "$current_guild")
  if [ -n "$new_guild" ]; then
    env_set "DISCORD_GUILD_ID" "$new_guild"
    ok "Guild ID saved"
  fi

  # Channel IDs
  current_channels=$(env_get "DISCORD_CHANNEL_IDS")
  new_channels=$(prompt_with_default "Allowed channel IDs (comma-separated, blank = all)" "$current_channels")
  env_set "DISCORD_CHANNEL_IDS" "$new_channels"

  # Allowed Users
  current_users=$(env_get "DISCORD_ALLOWED_USERS")
  new_users=$(prompt_with_default "Allowed user IDs (comma-separated, blank = all)" "$current_users")
  env_set "DISCORD_ALLOWED_USERS" "$new_users"

  echo ""
  ok "Discord saved"
else
  ok "Skipped — web-only mode"
fi

echo ""

# ═════════════════════════════════════════════════════════════════════════════
# Section 3/3: Projects
# ═════════════════════════════════════════════════════════════════════════════

printf "  ${CYAN}[3/3]${NC} ${BOLD}Projects${NC}\n"
echo ""

# Clean out example placeholder if it still exists
node -e "
  const fs = require('fs');
  const cfg = JSON.parse(fs.readFileSync('$CONFIG_FILE','utf8'));
  const p = cfg.projects || {};
  let changed = false;
  for (const [k, v] of Object.entries(p)) {
    if (v.path === '/absolute/path/to/your/project') { delete p[k]; changed = true; }
  }
  if (changed) { cfg.projects = p; fs.writeFileSync('$CONFIG_FILE', JSON.stringify(cfg, null, 2) + '\n'); }
"

# Show existing real projects
real_count=$(node -e "
  const cfg = JSON.parse(require('fs').readFileSync('$CONFIG_FILE','utf8'));
  const names = Object.keys(cfg.projects || {});
  console.log(names.length);
")

if [ "$real_count" -gt 0 ]; then
  info "Current projects:"
  node -e "
    const cfg = JSON.parse(require('fs').readFileSync('$CONFIG_FILE','utf8'));
    Object.entries(cfg.projects || {}).forEach(([n, p]) => {
      console.log('  \x1b[32m✓\x1b[0m ' + n + ' → ' + p.path + (p.description ? ' (' + p.description + ')' : ''));
    });
  "
  echo ""
fi

# Discover project directories from common locations
discover_dirs() {
  local dirs=()
  local search_roots=("$HOME/Desktop" "$HOME/Documents" "$HOME/Projects" "$HOME/projects" "$HOME/code" "$HOME/Code" "$HOME/dev" "$HOME/Dev" "$HOME/repos" "$HOME/src" "$HOME/work" "$HOME/Work")
  for root in "${search_roots[@]}"; do
    if [ -d "$root" ]; then
      for d in "$root"/*/; do
        [ -d "$d" ] || continue
        # Only suggest dirs that look like projects (have .git, package.json, etc.)
        if [ -d "$d/.git" ] || [ -f "$d/package.json" ] || [ -f "$d/Cargo.toml" ] || [ -f "$d/go.mod" ] || [ -f "$d/pyproject.toml" ] || [ -f "$d/requirements.txt" ] || [ -f "$d/Makefile" ] || [ -f "$d/pom.xml" ] || [ -f "$d/build.gradle" ]; then
          dirs+=("${d%/}")
        fi
      done
    fi
  done
  printf '%s\n' "${dirs[@]}"
}

pick_project_path() {
  local discovered=()
  while IFS= read -r line; do
    [ -n "$line" ] && discovered+=("$line")
  done < <(discover_dirs)

  if [ ${#discovered[@]} -gt 0 ]; then
    echo "" >&2
    info "Detected project directories:" >&2
    local i=1
    local show_count=${#discovered[@]}
    [ "$show_count" -gt 15 ] && show_count=15
    for ((idx=0; idx<show_count; idx++)); do
      local d="${discovered[$idx]}"
      local short="${d/#$HOME/~}"
      printf "  ${CYAN}%2d${NC}) %s\n" "$i" "$short" >&2
      i=$((i + 1))
    done
    if [ ${#discovered[@]} -gt 15 ]; then
      printf "  ${DIM}   ... and %d more${NC}\n" $(( ${#discovered[@]} - 15 )) >&2
    fi
    printf "  ${CYAN}%2d${NC}) ${DIM}Enter custom path${NC}\n" "$i" >&2
    echo "" >&2

    local choice
    choice=$(prompt_with_default "Pick a number")
    if [ -n "$choice" ] && [ "$choice" -eq "$choice" ] 2>/dev/null; then
      if [ "$choice" -ge 1 ] && [ "$choice" -le "$show_count" ]; then
        echo "${discovered[$((choice - 1))]}"
        return 0
      fi
    fi
  fi

  # Custom path fallback
  local raw_path
  raw_path=$(prompt_with_default "Project path")
  if [ -n "$raw_path" ]; then
    expand_path "$raw_path"
    return 0
  fi
  return 1
}

# Add projects loop
if [ "$real_count" -eq 0 ]; then
  info "Add your project directories so RemoteWiz can manage them."
  echo ""
fi

while true; do
  if [ "$real_count" -gt 0 ]; then
    add_more=$(prompt_with_default "Add another project? (y/n)" "n")
    if [[ ! "$add_more" =~ ^[Yy] ]]; then
      break
    fi
  fi

  proj_path=""
  if ! proj_path=$(pick_project_path) || [ -z "$proj_path" ]; then
    if [ "$real_count" -eq 0 ]; then
      warn "Skipped — add projects later in config.json"
    fi
    break
  fi

  # Suggest slug from directory name
  default_name=$(basename "$proj_path" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
  name=$(prompt_with_default "Project name" "$default_name")
  if [ -z "$name" ]; then
    warn "Name cannot be empty, skipping"
    continue
  fi

  if [ ! -d "$proj_path" ]; then
    warn "Directory not found: $proj_path"
    keep_going=$(prompt_with_default "Save anyway? (y/n)" "n")
    if [[ ! "$keep_going" =~ ^[Yy] ]]; then
      continue
    fi
  fi

  description=$(prompt_with_default "Description (optional)" "")

  node -e "
    const fs = require('fs');
    const cfg = JSON.parse(fs.readFileSync('$CONFIG_FILE','utf8'));
    cfg.projects = cfg.projects || {};
    cfg.projects[process.argv[1]] = {
      path: process.argv[2],
      description: process.argv[3] || '',
      tokenBudget: 150000,
      timeout: 600000,
      skipPermissions: false
    };
    fs.writeFileSync('$CONFIG_FILE', JSON.stringify(cfg, null, 2) + '\n');
  " "$name" "$proj_path" "$description"

  ok "Added: $name → $proj_path"
  echo ""
  real_count=$((real_count + 1))
done

echo ""

# ═════════════════════════════════════════════════════════════════════════════
# Summary
# ═════════════════════════════════════════════════════════════════════════════

printf "  ${GREEN}${BOLD}Configuration complete!${NC}\n"
echo ""
info "Summary:"

# API Key
final_key=$(env_get "ANTHROPIC_API_KEY")
if [ -n "$final_key" ]; then
  ok "Anthropic API Key: $(mask_value "$final_key")"
else
  warn "Anthropic API Key: (not set)"
fi

# Discord
final_token=$(env_get "DISCORD_TOKEN")
if [ -n "$final_token" ]; then
  ok "Discord: configured (token $(mask_value "$final_token"))"
else
  printf "  ${DIM}  Discord: not configured${NC}\n"
fi

# Projects
echo ""
info "Projects:"
node -e "
  const cfg = JSON.parse(require('fs').readFileSync('$CONFIG_FILE','utf8'));
  const names = Object.keys(cfg.projects || {});
  if (names.length === 0) { console.log('  (none)'); }
  else { names.forEach(n => {
    const p = cfg.projects[n];
    console.log('  \x1b[32m✓\x1b[0m ' + n + ' → ' + p.path);
  }); }
"

echo ""
info "Start the server:"
echo "  remotewiz"
echo ""
